steps:
- script: |
    if [ "$(BuildAndTestBuildImages)" != "true" ] && [ "$(BuildAndTestRuntimeImages)" != "true" ]
    then
      echo "Invalid configuration."
      echo "Variable 'BuildAndTestBuildImages' or 'BuildAndTestRuntimeImages' needs to be 'true' to run this build."
      exit 1
    fi
  displayName: 'Validate pipeline run'

- checkout: self
  clean: true

- task: ShellScript@2
  displayName: 'Build Oryx.sln'
  inputs:
    scriptPath: ./build/build-solution.sh
  condition: succeeded()

- task: ShellScript@2
  displayName: 'Build build images'
  inputs:
    scriptPath: ./build/build-buildimagesMCR.sh
  condition: and(succeeded(), eq(variables['BuildAndTestBuildImages'], 'true'))

- task: ShellScript@2
  displayName: 'Build runtime images'
  inputs:
    scriptPath: ./build/build-runtimeimagesMCR.sh
  condition: and(succeeded(), eq(variables['BuildAndTestRuntimeImages'], 'true'))

- task: ShellScript@2
  displayName: 'Test script generator'
  inputs:
    scriptPath: ./build/test-scriptgeneratorMCR.sh
  condition: and(succeeded(), eq(variables['BuildAndTestBuildImages'], 'true'))

- task: ShellScript@2
  displayName: 'Test build images'
  inputs:
    scriptPath: ./build/test-buildimagesMCR.sh
    args: skipBuildingImages
  condition: and(succeeded(), eq(variables['BuildAndTestBuildImages'], 'true'))

- task: ShellScript@2
  displayName: 'Test runtime images'
  inputs:
    scriptPath: ./build/test-runtimeimagesMCR.sh
    args: skipBuildingImages
  condition: and(succeeded(), eq(variables['BuildAndTestRuntimeImages'], 'true'))

- task: CopyFiles@2
  displayName: 'Copy source projects output to artifacts folder'
  inputs:
    sourceFolder: $(Build.SourcesDirectory)
    contents: 'src/**/bin/**/*.*'
    targetFolder: $(Build.ArtifactStagingDirectory)
    cleanTargetFolder: true
    overWrite: true
    flattenFolders: true

- task: CopyFiles@2
  displayName: 'Copy artifacts from source repo to agent artifacts folder'
  inputs:
    sourceFolder: '$(Build.SourcesDirectory)/artifacts'
    contents: '**/*.*'
    targetFolder: $(Build.ArtifactStagingDirectory)
    overWrite: true

- task: PublishTestResults@2
  inputs:
    testRunner: 'xUnit'
    testResultsFiles: '$(Build.ArtifactStagingDirectory)/testResults/*.xml'
    mergeTestResults: true

- task: Docker@0
  displayName: 'Push Build image'
  inputs:
    azureSubscription: OryxMCR
    azureContainerRegistry: '{"loginServer":"oryxdevmcr.azurecr.io", "id" : "/subscriptions/e13e3c2a-b6ed-4969-875a-28bec9f4513f/resourceGroups/oryxtrymcr/providers/Microsoft.ContainerRegistry/registries/oryxdevmcr"}'
    imageNamesPath: '$(Build.ArtifactStagingDirectory)/images/build-images.txt'
    includeLatestTag: false
  condition: and(succeeded(), eq(variables['PushBuildImages'], 'true'), eq(variables['BuildAndTestBuildImages'], 'true'))

- task: Docker@0
  displayName: 'Push runtime images'
  inputs:
    azureSubscription: OryxMCR
    azureContainerRegistry: '{"loginServer":"oryxdevmcr.azurecr.io", "id" : "/subscriptions/e13e3c2a-b6ed-4969-875a-28bec9f4513f/resourceGroups/oryxtrymcr/providers/Microsoft.ContainerRegistry/registries/oryxdevmcr"}'
    imageNamesPath: '$(Build.ArtifactStagingDirectory)/images/runtime-images.txt'
    includeLatestTag: false
  condition: and(succeeded(), eq(variables['PushRuntimeImages'], 'true'), eq(variables['BuildAndTestRuntimeImages'], 'true'))

- task: ShellScript@2
  displayName: 'Clean up docker artifacts'
  inputs:
    scriptPath: ./vsts/scripts/dockerCleanup.sh
  condition: or(eq(variables['BuildAndTestBuildImages'], 'true'), eq(variables['BuildAndTestRuntimeImages'], 'true'))

- task: ArchiveFiles@2
  displayName: 'Archive docker files and scripts for Oryx build and runtime images'
  inputs:
    rootFolderOrFile: images
    archiveFile: '$(Build.ArtifactStagingDirectory)/images/dockerFiles.zip'

- task: PublishBuildArtifacts@1
  displayName: 'Publish Artifact: drop'